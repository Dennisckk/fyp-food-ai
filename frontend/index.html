<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FYP Food AI</title>
    <style>
      :root{
        --bg:#f6f7fb;
        --card:#ffffff;
        --text:#111827;
        --muted:#6b7280;
        --border:#e5e7eb;
        --shadow: 0 10px 30px rgba(0,0,0,.06);
        --radius: 14px;
        --gap: 14px;
      }

      *{ box-sizing:border-box; }
      body{
        margin:0;
        height:100vh;
        overflow:hidden; 
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        color:var(--text);
        background:var(--bg);
      }

      .app{
        height:100vh;
        display:flex;
        flex-direction:column;
      }

      /* Top header */
      .topbar{
        padding: 16px 18px;
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap: 12px;
        border-bottom:1px solid var(--border);
        background:rgba(255,255,255,.7);
        backdrop-filter: blur(10px);
      }
      .title{
        display:flex;
        flex-direction:column;
        gap:4px;
      }
      .title h1{
        margin:0;
        font-size:18px;
        letter-spacing:.2px;
      }
      .title .sub{
        margin:0;
        font-size:12.5px;
        color:var(--muted);
      }

      .pill{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding:6px 10px;
        border:1px solid var(--border);
        border-radius:999px;
        background:#fff;
        color:var(--muted);
        font-size:12px;
        white-space:nowrap;
      }

      /* Main dashboard grid */
      .dash{
        flex:1;
        padding: 14px 18px 18px;
        display:grid;
        grid-template-columns: 2fr 1fr; 
        gap: var(--gap);
        min-height:0; 
      }

      /* Cards */
      .card{
        background:var(--card);
        border:1px solid var(--border);
        border-radius:var(--radius);
        box-shadow:var(--shadow);
        padding: 12px 12px 10px;
        min-height:0; 
      }
      .card h3{
        margin: 0 0 10px 0;
        font-size:14px;
        letter-spacing:.2px;
      }
      .muted{ color:var(--muted); font-size:12.5px; }

      .left{
        display:grid;
        grid-template-rows: auto 1fr; 
        gap: var(--gap);
        min-height:0;
      }

      .uploadRow{
        display:grid;
        grid-template-columns: 1fr auto;
        align-items:center;
        gap: 10px;
      }

      .controls{
        display:flex;
        align-items:center;
        gap:10px;
        flex-wrap:wrap;
        margin-top: 10px;
      }

      input[type="file"]{
        width:100%;
      }

      /* Buttons */
      button{
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid #111827;
        background: #111827;
        color: #fff;
        cursor: pointer;
        font-weight:600;
        font-size:13px;
      }
      button:disabled{ opacity:.5; cursor:not-allowed; }

      .btnSecondary{
        background:#fff;
        color:#111827;
        border:1px solid var(--border);
        font-weight:600;
      }

      /* Link as button */
      a.linkBtn{
        display:inline-flex;
        align-items:center;
        justify-content:center;
        padding: 10px 12px;
        border-radius: 10px;
        border:1px solid var(--border);
        background:#fff;
        color:#111827;
        text-decoration:none;
        font-weight:600;
        font-size:13px;
      }

      .leftGrid{
        display:grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        gap: var(--gap);
        min-height:0;
      }
      .span2{ grid-column: 1 / span 2; }

      .imgBox{
        width: 100%;
        height: 100%;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #f3f4f6;
        display:flex;
        align-items:center;
        justify-content:center;
        overflow:hidden;
        min-height:0;
      }
      .imgBox img{
        max-width:100%;
        max-height:100%;
        object-fit:contain;
        display:block;
      }

      .right{
        display:grid;
        grid-template-rows: 0.95fr 1.05fr;
        gap: var(--gap);
        min-height:0;
      }

      .scrollArea{
        overflow:auto;
        min-height:0;
      }

      table{
        width:100%;
        border-collapse:collapse;
      }
      th, td{
        border-bottom: 1px solid #f0f1f5;
        padding: 8px 8px;
        text-align:left;
        font-size: 13px;
        vertical-align:top;
      }
      th{
        position:sticky;
        top:0;
        background:#fafafa;
        z-index:1;
      }

      .total{
        font-size:14px;
        font-weight:800;
        margin-top: 10px;
      }

      pre{
        background:#0b1020;
        color:#e6e6e6;
        padding:12px;
        border-radius:12px;
        overflow:auto;
        max-height: 220px;
      }

      .warnBox{
        display:none;
        margin-top:10px;
        padding:10px 12px;
        border:1px solid #f2c94c;
        background:#fff7d6;
        border-radius:12px;
        font-size:13px;
      }

      /* History controls row */
      .historyControls{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        align-items:center;
        margin-bottom: 10px;
      }
      select{
        padding: 8px 10px;
        border-radius: 10px;
        border:1px solid var(--border);
        background:#fff;
      }

      .imgCard {
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      .imgCard .imgBox{
        height: clamp(240px, 34vh, 380px); 
        min-height: 220px;
      }

      .imgBox img{
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
      }

      .right > .card{
        height: 100%;
        min-height: 0;
      }

      .resultsCard{
        display:flex;
        flex-direction:column;
        min-height:0;
      }

      .resultsCard .scrollArea{
        flex: 1;        
        min-height: 0;
        overflow:auto;    
      }

      .resultsCard details pre{
        max-height: 220px;
        overflow:auto;
      }

      .resultsCard details pre,
      pre#out{
        white-space: pre;     
        overflow-x: auto;        
        overflow-y: auto;       
        max-height: 220px;       
      }

      .resultsCard .scrollArea,
      .resultsCard details,
      .resultsCard pre{
        min-width: 0;
      }

      /* --- Grad-CAM split layout (image left, text right) --- */
      .camCard{
        display:flex;
        flex-direction:column;
        min-height:0;
        margin-bottom: 6px;
      }

      .camHeader{
        margin-bottom: 4px;   
        min-height: 0;    
        display:flex;
        justify-content:flex-start;
        align-items:center;
      }

      .camLayout{
        flex: 1;                 
        min-height:0;
        display:flex;
        gap:12px;
      }

      .camLeft{ flex: 1.45; min-width:0; min-height:0; }
      .camRight{ flex: 0.55; min-width:0; min-height:0; }

      .camImgBox{ height:100%; min-height:0; }

      .camImgBox img{
        width:100%;
        height:100%;
        object-fit:contain;
        display:block;
      }

      .camText{
        height:100%;
        min-height:0;
        border:1px solid var(--border);
        border-radius:12px;
        padding:12px;
        background:#fff;

        display:flex;
        flex-direction:column;
        gap:8px;
      }

      .camTitle{ margin:0; }

      .camTextBody{
        flex:1;
        min-height:0;
        overflow:auto;           
        line-height:1.45;
      }

      @media (max-width: 1020px){
        .camLayout{
          flex-direction:column;
          height:auto;
        }
        .camImgBox{ height:300px; }
        .camTextBody{ max-height:220px; }
      }

      /* Responsive: stack on smaller screens */
      @media (max-width: 1020px){
        body{ overflow:auto; } /* allow scroll on small screens */
        .dash{ grid-template-columns: 1fr; }
        .right{ grid-template-rows: auto auto; }
        .leftGrid{ grid-template-columns: 1fr; grid-template-rows: auto auto auto; }
        .span2{ grid-column:auto; }
        pre{ max-height: 260px; }
      }

      /* .resultsCard .scrollArea{
        overflow-y: auto;
        overflow-x: hidden;
      }

      .jsonBox{
        max-width: 100%;
        overflow-x: scroll; 
        overflow-y: auto;
        border-radius: 12px; 
      }

      .jsonBox #out{
        margin: 0;
        white-space: pre;     
        min-width: max-content; 
      }

      .jsonBox::-webkit-scrollbar{
        height: 12px;
      } */

    </style>
  </head>

  <body>
    <div class="app">
      <div class="topbar">
        <div class="title">
          <h1>FYP Food AI</h1>
          <p class="sub">Ingredient Detection • Portion (S/M/L) • Calories • Grad-CAM</p>
        </div>
        <div class="pill">
          <span>Confidence</span>
          <strong id="confVal">0.35</strong>
        </div>
      </div>

      <div class="dash">
        <!-- LEFT MAIN -->
        <div class="left">
          <div class="card">
            <h3>Upload & Predict</h3>
            <div class="uploadRow">
              <input type="file" id="img" accept="image/*" />
              <div class="muted" id="status"></div>
            </div>

            <div class="controls">
              <label class="muted" style="display:flex; gap:10px; align-items:center;">
                Confidence:
                <input type="range" id="conf" min="0.05" max="0.60" step="0.05" value="0.35" />
              </label>

              <button id="btn">Predict</button>
              <button id="download" class="btnSecondary" disabled>Download Report (CSV)</button>
            </div>
          </div>

          <div class="leftGrid">
            <div class="card imgCard">
              <h3>Selected Image</h3>
              <div class="imgBox" style="height:100%;">
                <img id="preview" style="display:none;" />
              </div>
              <div class="muted" style="margin-top:8px;">Tip: try close-up, plate-style photos for better detection.</div>
            </div>

            <div class="card imgCard">
              <h3>Annotated Result</h3>
              <div class="imgBox">
                <img id="annotated" style="display:none;" />
              </div>
              <div class="muted" style="margin-top:8px;">Boxes + labels are based on your confidence slider.</div>
            </div>

            <div class="card span2 camCard">
              <h3>Grad-CAM Explanation</h3>

              <!-- Header ONLY for status (left aligned) -->
              <div class="camHeader">
                <div id="explainStatus" class="muted"></div>
              </div>

              <div class="camLayout">
                <!-- LEFT: image -->
                <div class="camLeft">
                  <div class="imgBox camImgBox">
                    <img id="explainImg" style="display:none;" />
                  </div>
                </div>

                <!-- RIGHT: explanation -->
                <div class="camRight">
                  <div class="camText">
                    <div class="muted camTitle">Explanation</div>
                    <div id="explainText" class="camTextBody"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT SIDEBAR -->
        <div class="right">
          <div class="card resultsCard">
            <h3>Results</h3>

            <div id="summary" class="muted">No prediction yet.</div>

            <div id="warn" class="warnBox">
              ⚠️ <b>Note:</b> Some styles (e.g., whole fish on tray / strong background) may not be detected until retraining.
            </div>

            <div class="scrollArea" style="margin-top:10px;">
              <table id="tbl" style="display:none;">
                <thead>
                  <tr>
                    <th>Ingredient</th>
                    <th>Confidence</th>
                    <th>Size</th>
                    <th>Calories</th>
                  </tr>
                </thead>
                <tbody id="tbody"></tbody>
              </table>

              <div class="total" id="total" style="display:none;"></div>

              <details style="margin-top:10px;">
                <summary class="muted">Show raw JSON</summary>
                <div class="jsonBox">
                  <pre id="out"></pre>
                </div>
              </details>
            </div>
          </div>

          <div class="card" style="display:flex; flex-direction:column;">
            <h3>History</h3>

            <div class="historyControls">
              <button id="btnHistory" type="button" class="btnSecondary">Refresh</button>
              <button id="btnPrev" type="button" class="btnSecondary">Prev</button>
              <button id="btnNext" type="button" class="btnSecondary">Next</button>

              <span class="muted" id="pageInfo"></span>

              <select id="historyLimit" title="Cap">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>

              <a id="btnDownloadHistory" class="linkBtn" href="/history.csv" download>Download All CSV</a>
              <span class="muted" id="historyStatus"></span>
            </div>

            <div class="scrollArea">
              <table id="historyTable" style="display:none;">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Filename</th>
                    <th>Conf</th>
                    <th>Total</th>
                    <th>Items</th>
                  </tr>
                </thead>
                <tbody id="historyTbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const fileInput = document.getElementById("img");
      const previewImg = document.getElementById("preview");
      const annotatedImg = document.getElementById("annotated");
      const btn = document.getElementById("btn");
      const out = document.getElementById("out");
      const statusEl = document.getElementById("status");
      const confSlider = document.getElementById("conf");
      const confVal = document.getElementById("confVal");

      const tbl = document.getElementById("tbl");
      const tbody = document.getElementById("tbody");
      const summary = document.getElementById("summary");
      const totalEl = document.getElementById("total");
      const warn = document.getElementById("warn");
      const downloadBtn = document.getElementById("download");

      const btnHistory = document.getElementById("btnHistory");
      const historyTable = document.getElementById("historyTable");
      const historyTbody = document.getElementById("historyTbody");
      const historyStatus = document.getElementById("historyStatus");
      const historyLimit = document.getElementById("historyLimit");
      const btnDownloadHistory = document.getElementById("btnDownloadHistory");

      const explainImg = document.getElementById("explainImg");
      const explainStatus = document.getElementById("explainStatus");
      const explainTextEl = document.getElementById("explainText");

      let explainUrl = null;
      let currentPage = 1;
      const PAGE_SIZE = 10;
      let maxItems = Number(historyLimit.value) || 20;

      const btnPrev = document.getElementById("btnPrev");
      const btnNext = document.getElementById("btnNext");
      const pageInfo = document.getElementById("pageInfo");

      async function refreshHistory() {
        try {
          historyStatus.textContent = "Loading…";
          maxItems = Number(historyLimit.value) || 20;
          updateDownloadLink();

          const res = await fetch(`/history?page=${currentPage}&page_size=${PAGE_SIZE}&max_items=${maxItems}`);
          const data = await res.json();

          const rows = data.rows || [];
          const total = data.total || 0;

          historyTbody.innerHTML = "";

          if (!rows.length) {
            historyTable.style.display = "none";
            historyStatus.textContent = "No history yet.";
            pageInfo.textContent = "";
            return;
          }

          for (const r of rows) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${r.timestamp ?? ""}</td>
              <td>${r.filename ?? ""}</td>
              <td>${r.conf ?? ""}</td>
              <td>${r.total_calories_estimate ?? ""}</td>
              <td style="max-width:520px; white-space:normal;">${r.items ?? ""}</td>
            `;
            historyTbody.appendChild(tr);
          }

          historyTable.style.display = "table";

          const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
          pageInfo.textContent = `Page ${currentPage} / ${totalPages} (Total: ${total}, Cap: ${maxItems})`;

          updateDownloadLink(total);

          btnPrev.disabled = currentPage <= 1;
          btnNext.disabled = currentPage >= totalPages;

          historyStatus.textContent = `Showing ${rows.length} items.`;
        } catch (e) {
          console.error(e);
          historyStatus.textContent = "Failed to load history (check backend).";
        }
      }

      function updateDownloadLink(total) {
        // download ALL within cap (50/100/etc). page_size default = 0 on backend
        btnDownloadHistory.href = `/history.csv?max_items=${maxItems}&t=${Date.now()}`;
      }

      btnPrev.addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          refreshHistory();
        }
      });

      btnNext.addEventListener("click", () => {
        currentPage++;
        refreshHistory();
      });

      btnHistory.addEventListener("click", () => {
        currentPage = 1;
        refreshHistory();
      });

      historyLimit.addEventListener("change", () => {
        currentPage = 1;
        refreshHistory();
      });

      let lastReportId = null;
      let prevUrl = null;
      let annotatedUrl = null;

      confSlider.addEventListener("input", () => {
        confVal.textContent = Number(confSlider.value).toFixed(2);
      });

      fileInput.addEventListener("change", () => {
        const file = fileInput.files?.[0];

        if (!file) {
          previewImg.style.display = "none";
          previewImg.removeAttribute("src");
          return;
        }

        if (prevUrl) URL.revokeObjectURL(prevUrl);
        prevUrl = URL.createObjectURL(file);

        previewImg.src = prevUrl;
        previewImg.style.display = "block";
      });

      function renderTable(data) {
        const dets = data?.detections ?? [];
        tbody.innerHTML = "";

        if (!dets.length) {
          tbl.style.display = "none";
          totalEl.style.display = "none";

          summary.innerHTML = `
            <b>No ingredients detected.</b><br/>
            Try these tips:<br/>
            • Lower confidence (e.g., 0.05–0.15)<br/>
            • Move closer so food fills most of the image<br/>
            • Use a plate-style photo (less background)<br/>
            • Try a different angle / better lighting
          `;

          warn.style.display = "block";
          return;
        }

        for (const d of dets) {
          const tr = document.createElement("tr");
          const cal = (d.calories !== undefined) ? d.calories : 0;

          tr.innerHTML = `
            <td>${d.label}</td>
            <td>${Number(d.confidence ?? 0).toFixed(2)}</td>
            <td>${d.size ?? "-"}</td>
            <td>${Number(cal).toFixed(2)}</td>
          `;
          tbody.appendChild(tr);
        }

        tbl.style.display = "table";
        summary.textContent = `Detected ${dets.length} ingredient(s).`;
        warn.style.display = "none";

        const total = data?.total_calories_estimate ?? 0;
        totalEl.textContent = `Total calories (estimate): ${Number(total).toFixed(2)} kcal`;
        totalEl.style.display = "block";
      }

      async function postFile(url, file) {
        const fd = new FormData();
        fd.append("file", file);
        return fetch(url, { method: "POST", body: fd });
      }

      btn.onclick = async () => {
        if (!fileInput.files.length) return alert("Choose an image first");
        const file = fileInput.files[0];

        btn.disabled = true;
        statusEl.textContent = "Predicting…";

        const conf = Number(confSlider.value).toFixed(2);
        const API_JSON = `/predict?conf=${encodeURIComponent(conf)}`;
        const API_IMG  = `/predict_annotated?conf=${encodeURIComponent(conf)}`;
        const API_CAM  = `/explain?conf=${encodeURIComponent(conf)}`;
        const API_EXPLAIN_TEXT = `/explain_text?conf=${encodeURIComponent(conf)}`;

        try {
          // 1) JSON
          const res1 = await postFile(API_JSON, file);
          if (!res1.ok) throw new Error(`JSON endpoint failed: ${res1.status}`);
          const data = await res1.json();
          lastReportId = data.report_id || null;
          downloadBtn.disabled = !lastReportId;
          out.textContent = JSON.stringify(data, null, 2);
          renderTable(data);
          await refreshHistory();

          // 2) Annotated image
          const res2 = await postFile(API_IMG, file);
          if (!res2.ok) throw new Error(`Image endpoint failed: ${res2.status}`);
          const blob = await res2.blob();

          if (annotatedUrl) URL.revokeObjectURL(annotatedUrl);
          annotatedUrl = URL.createObjectURL(blob);
          annotatedImg.src = annotatedUrl;
          annotatedImg.style.display = "block";

          // 3) Explanation (heatmap)
          explainStatus.textContent = "Generating explanation…";
          try {
            const res3 = await postFile(API_CAM, file);
            if (!res3.ok) throw new Error(`Explain endpoint failed: ${res3.status}`);
            const camBlob = await res3.blob();

            if (explainUrl) URL.revokeObjectURL(explainUrl);
            explainUrl = URL.createObjectURL(camBlob);

            explainImg.src = explainUrl;
            explainImg.style.display = "block";
            explainStatus.textContent = "";
          } catch (e) {
            console.warn(e);
            explainImg.style.display = "none";
            explainStatus.textContent = "Explanation not available (check backend terminal).";
          }

          // 4) Explanation text (auto)
          try {
            const res4 = await postFile(API_EXPLAIN_TEXT, file);
            if (!res4.ok) throw new Error(`Explain text failed: ${res4.status}`);
            const txtData = await res4.json();
            explainTextEl.innerHTML = txtData.explanation || "";
          } catch (e) {
            console.warn(e);
            explainTextEl.innerHTML = "<i>Explanation text not available.</i>";
          }

          statusEl.textContent = "Done.";
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Error. Check terminal logs.";
          alert(err.message);
        } finally {
          btn.disabled = false;
        }
      };

      downloadBtn.onclick = async () => {
        if (!lastReportId) {
          alert("No report yet. Click Predict first.");
          return;
        }

        const url = `/report/${lastReportId}.csv`;
        const r = await fetch(url);
        if (!r.ok) {
          alert("Report not found. Please click Predict again.");
          return;
        }

        const blob = await r.blob();
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `report_${lastReportId}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      };

      // Optional: show history immediately on load
      window.addEventListener("load", () => {
        refreshHistory();
      });
    </script>
  </body>
</html>
